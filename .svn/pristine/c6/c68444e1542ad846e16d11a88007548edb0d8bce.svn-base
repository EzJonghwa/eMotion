
<%
  /* ================================================================= 
   * 작성일     : 2024. 12. 16. 
   * 작성자     : 철규
   * 상세설명  : 회원가입
   * 화면ID : 
   * ================================================================= 
   * 수정일         작성자             내용      
   * ----------------------------------------------------------------------- 
   * 
   * ================================================================= 
   */
%>

<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form"%>
<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- 프레임 워크 jquery and bootStrap-->
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<!-- 대음 주소 api -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<title>kakaomypage</title>
</head>

<style>
body {
	background-color: #B7B7B7
}

.container {
	height: 1400px;
	border-radius: 10px;
}

@media ( min-width : 768px) {
	.container {
		width: 768px;
	}
}

@media ( min-width : 992px) {
	.container {
		width: 768px;
	}
}

@media ( min-width : 1200px) {
	.container {
		width: 768px;
	}
}

.hdstyle {
	background-color: white;
}

.mainheader {
	height: 160px;
}

.mainbody {
	background-color: #ffffff;
}

.bdr {
	border-radius: 10px;
	transition-duration: 0.3s;
}

.bdr:hover {
	transform: scale(0.99);
}

.bdrt {
	border-top-left-radius: 10px;
	border-top-right-radius: 10px;
}

.bdrb {
	border-bottom-left-radius: 10px;
	border-bottom-right-radius: 10px;
}

.bd3px {
	border: 4px solid white;
}

.textmenu {
	font-size: 25px;
	color: white;
	font-weight: 1000;
}

.menu {
	width: 75px;
	height: 75px;
	border: 1px solid;
}

.fontmain {
	font-size: 70px;
	font-weight: 1000;
	text-align: center;
}

.fontover {
	text-align: center;
	font-size: 30px;
	font-weight: 700
}

.btn_log {
	border-radius: 10px;
	padding: 12px 15px;
	width: 100%;
	height: 100px;
}

.log {
	height: 100px;
	margin-bottom: 10px;
	border-radius: 20px
}

.log_email {
	height: 80px;
	margin-bottom: 10px;
	border-radius: 20px
}

.log_last {
	height: 100px;
	border-radius: 20px;
	margin-bottom: 20px;
}

.btn-primary {
	background-color: #50B0FF;
	border: none;
}

.btn-primary:hover {
	background-color: #37a1f8;
}

.btn-primary:active {
	background-color: #50B0FF;
}

a {
	color: #37a1f8;
}

.brdimg {
	border: 1px dashed;
	border-radius: 100%;
}
</style>


<script>

    // 로그인 validation 
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form");
        const emailInput = document.querySelector("input[type='text']");
        const passwordInput = document.querySelector("input[type='password']");
        const nameInput = document.querySelector("input[type='name']");

        form.addEventListener("submit", function (event) {
            // 초기화
            let isValid = true;
            const emailError = document.querySelector("#emailError");
            const passwordError = document.querySelector("#passwordError")
            const nameError = document.querySelector("#nameError")


            if (emailInput.value.trim() === "") {
                emailError.textContent = "이메일을 입력해주세요.";
                isValid = false;
            } 
            else {
                emailError.textContent = ""; // 오류 메시지 제거
            }
            // 비밀번호 유효성 검사
            if (passwordInput.value.trim() === "") {
                passwordError.textContent = "비밀번호를 입력해주세요.";
                isValid = false;
            } 
            else if (passwordInput.value.trim().length < 6) {
                passwordError.textContent = "비밀번호는 최소 6자 이상이어야 합니다.";
                isValid = false;
            } 
            else {
                passwordError.textContent = ""; // 오류 메시지 제거
            }

            if (nameInput.value.trim() === "") {
                nameError.textContent = "닉네임을 입력해주세요.";
                isValid = false;
            } else {
                nameError.textContent = ""; // 오류 메시지 제거
            }
            // 유효하지 않으면 기본 동작 취소
            if (!isValid) {
                event.preventDefault();
            }
        });
    });
    
function findAddr() {

    new daum.Postcode({
        oncomplete: function (data) {
            // 사용자 주소를 받아올 변수를 정의한다.
            var addr = '';
            var pos = data.zonecode;

            //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
            if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우(R)
                addr = data.roadAddress;
            } else { // 사용자가 지번 주소를 선택했을 경우(J)
                addr = data.jibunAddress;
            }

            // 부모창의 주소칸에 받아온 주소를 넣는다.
            $("#addr").val(addr);
        }
    }).open();
}
    
$(document).ready(function () {
	
    // 회원탈퇴 버튼 클릭 시 모달 열기
    $('#exit').on("click", function () {
      var exitModal = new bootstrap.Modal(document.getElementById('exitConfirmModal'), {});
      exitModal.show();
    });

    // 모달의 확인 버튼 클릭 시 AJAX 요청
    $('#confirmExit').on("click", function () {
      let email = $('#email').val();
      let data = { 'email': email };

      $.ajax({
        method: "GET",
        url: "/emailExit",
        data: data,
        success: function (data) {
          // 탈퇴 성공 후 홈 화면 이동
          window.location.href = "/";
        },
        error: function (request, status, error) {
          console.log("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
        }
      })
    });
  });
    
//이미지 업로드
$(document).ready(function(){
	$("#myImage").click(function(){
		$("#uploadImage").click();
	});
	
	// 이미지 업로드
	$("#uploadImage").on("change", function(){
		let file = $(this)[0].files[0];
		if(file){
			let fileType = file['type'];
			let valTypes = ['image/gif','image/jpeg','image/jpg','image/png'];
			if(!valTypes.includes(fileType)){
				alert("유효한 이미지 타입이 아닙니다.!!");
				$(this).val(''); //선택파일 초기화
			} else {
				// FormData HTML 폼 데이터를 쉽게 가져오도록 하는
				// submit이 아닌 비동기로 폼데이터를 전송하기 위해
				//let formData = new FormData($("#profileForm")[0]);
				
				// FormData 객체 생성
		        let formData = new FormData();
		        formData.append("uploadImage", file);
		        
				$.ajax({
					url : '<c:url value="/files/upload" />',
					type : "POST",
					data : formData,
					dataType : 'json',
					processData : false,  // formData 객체를 URL 인코딩하지 않도록
					contentType : false,  // 디폴트 전송인 application/x-www-form-urlencoded로 전송하지 않도록
										  // 파일은  multipart/form-data 이전 데이터 형태로 전송
					success : function(res){
						console.log(res);
						if(res.message == 'success'){
							$("#myImage").attr("src", "${pageContext.request.contextPath}" + res.imagePath);
						}
					},error:function(e){
						console.log(e);
					}
				});
			}
		}
	});
});
    
</script>


<body>

	<div class="container p-0 mainpage">
		<div class="container hdstyle">
			<div class="row mainheader mb-5"
				style="box-shadow: 0px 5px 0px 0px #d6edff;">
				<div class="col mx-2 d-flex align-items-center justify-content-start">
					<div class="" style="cursor: pointer; margin-right: 20px;" onclick="location.href='${pageContext.request.contextPath}/';">
						<h1>
							<
						</h1>
					</div>

					<div style="cursor: pointer;" onclick="location.href='${pageContext.request.contextPath}/';">
						<div class="fontmain">
							<span style="color: #FFD050;">e</span>
							<span style="color: #50B0FF;">Motion</span>
							<span style="font-size: 30px; color: #828282;">나의 회원정보</span>
						</div>
					</div>
				</div>
			</div>

			<div class="row mainheader mx-3">
				<div class="col d-flex align-items-center justify-content-center">

					<form action="/updateKakaoMypage" method="post" style="width: 100%">
						<div class="row px-3 d-flex align-items-center">
							<div class="brdimg" style="width: 130px; height: 130px; border-radius: 50%; overflow: hidden; padding: 0;">
								<c:if test="${sessionScope.login.profileImg == null}">
									<img src="${pageContext.request.contextPath}/assets/img/non.png"
										id="myImage" class="img-fluid shadow-sm w-100 h-100" style="cursor: pointer;">
									</c:if>
								<c:if test="${sessionScope.login.profileImg != null}">
									<img src="${pageContext.request.contextPath}${sessionScope.login.profileImg}"
										id="myImage" class="img-fluid shadow-sm w-100 h-100" style="cursor: pointer;">
									</c:if>
								<input type="file" name="uploadImage" id="uploadImage" accept="image/*" style="display: none;">
							</div>
							<div class="col fs-4">
								<label class="fs-4 m-2">
									아이디(이메일)
									<button class="btn btn-warning">카카오</button>
								</label> 
								<input class="form-control log_email fs-3" id="email" name="email" type="text" value="${sessionScope.login.email}" readonly />
							</div>
						</div>

						<div class="row">

							<div class="col">
							</div>
							
							<div class="col" style="text-align: end;">
								<label id="emailError" class="text-danger mt-3 mx-2"></label>
							</div>
						</div>

						<div class="row">
							<div class="col">
								<label class="fs-4 m-2">이름(닉네임)</label>
							</div>
							<div class="col" style="text-align: end;">
								<label id="nameError" class="text-danger mt-3 mx-2"></label>
							</div>
						</div>
						<input class="form-control log fs-3" id="name" name="nickName" type="text" value="${sessionScope.login.nickName}"/>

						<div class="row">
							<div class="col">
								<label class="fs-4 m-2">생년월일</label>
							</div>
						</div>
						<input class="form-control log fs-3" id="birth" name="birthYear" type="date" value="${sessionScope.login.birthYear}" />

						<div class="row">
							<div class="col">
								<label class="fs-4 m-2" >주소</label>
							</div>
						</div>
						
						<input onclick="findAddr()" class="form-control log_last fs-3" value="${sessionScope.login.addr}" id="addr" name="addr" readonly />
						
						<button class="btn btn-primary btn_log mb-2 fs-3" id="submitButton" type="submit">수정</button>
						<hr style="border-top: 2px dashed black;">
					</form>

				</div>

				<div class="d-flex justify-content-center">
					<button class="btn btn-link" style="font-weight: 1000;" id="exit">회원탈퇴</button>
				</div>
			</div>

		</div>
	</div>
	
	
	<!-- 회원탈퇴 확인 모달 -->
		<div class="modal fade" id="exitConfirmModal" tabindex="-1" aria-labelledby="exitConfirmModalLabel" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="exitConfirmModalLabel">회원탈퇴 확인</h5>
		        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
		      </div>
		      <div class="modal-body">
		        	정말로 탈퇴하시겠습니까? 이 작업은 되돌릴 수 없습니다.
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
		        <button type="button" class="btn btn-danger" id="confirmExit">확인</button>
		      </div>
		    </div>
		  </div>
		</div>
</body>

</html>